{% extends 'detection/base.html' %}

{% block title %}Lista Video - YOLO Detection{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-collection-play"></i> Video Caricati</h1>
    </div>
    <div class="col text-end">
        <a href="{% url 'upload_video' %}" class="btn btn-primary rounded-2xl">
            <i class="bi bi-cloud-upload"></i> Carica Nuovo Video
        </a>
    </div>
</div>

{% if videos %}
<div class="row">
    {% for video in videos %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 shadow-sm rounded-2xl">
            <div class="card-body">
                <h5 class="card-title">{{ video.title }}</h5>
                <p class="card-text soft">
                    <small>Caricato il {{ video.created_at|date:"d/m/Y H:i" }}</small>
                </p>

                {% if video.status == 'pending' %}
                <span class="badge rounded-pill bg-secondary status-badge">
                    <i class="bi bi-hourglass-split"></i> In Attesa
                </span>
                {% elif video.status == 'processing' %}
                <span class="badge rounded-pill bg-info status-badge">
                    <i class="bi bi-arrow-repeat"></i> Elaborazione {{ video.progress_percentage }}%
                </span>
                <div class="progress mt-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width: {{ video.progress_percentage }}%"></div>
                </div>
                {% elif video.status == 'completed' %}
                <span class="badge rounded-pill bg-success status-badge">
                    <i class="bi bi-check-circle"></i> Completato
                </span>
                <p class="mt-2 mb-0 soft">
                    <small><strong>{{ video.detections_count }}</strong> rilevazioni</small>
                </p>
                {% elif video.status == 'failed' %}
                <span class="badge rounded-pill bg-danger status-badge">
                    <i class="bi bi-exclamation-triangle"></i> Errore
                </span>
                {% endif %}
            </div>
            <div class="card-footer bg-white d-flex justify-content-between">
                <a href="{% url 'video_detail' video.pk %}" class="btn btn-sm btn-outline-primary rounded-2xl">
                    <i class="bi bi-eye"></i> Visualizza
                </a>
                <form action="{% url 'delete_video' video.pk %}" method="post"
                    onsubmit="return confirm('Eliminare questo video?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-2xl">
                        <i class="bi bi-trash"></i> Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if is_paginated %}
<nav aria-label="Paginazione">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Precedente</a>
        </li>
        {% endif %}
        <li class="page-item disabled">
            <span class="page-link">Pagina {{ page_obj.number }} di {{ page_obj.paginator.num_pages }}</span>
        </li>
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Successivo</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="empty text-center">
    <i class="bi bi-info-circle fs-1"></i>
    <h4 class="mt-3">Nessun video caricato</h4>
    <p class="soft">Inizia caricando il tuo primo video per l'analisi</p>
    <a href="{% url 'upload_video' %}" class="btn btn-primary mt-2 rounded-2xl">
        <i class="bi bi-cloud-upload"></i> Carica Video
    </a>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh per card in processing
    setInterval(() => {
        const processing = document.querySelectorAll('.badge.bg-info');
        if (processing.length > 0) location.reload();
    }, 5000);
</script>
{% endblock %}